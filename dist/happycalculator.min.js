"use strict";if("object"==typeof module&&module&&"object"==typeof module.exports)var _=require("lodash");var Formulas={sqrt:"$1 * $1",add:"$1 + $2"},Calculator={formulas:_.clone(Formulas),ops:{"-":{prec:2,assoc:"Left"},"+":{prec:2,assoc:"Left"},"*":{prec:3,assoc:"Left"},"/":{prec:3,assoc:"Left"}},__result:function(t,e,s){var r;switch(s){case"+":r=t+e;break;case"-":r=t-e;break;case"*":r=t*e;break;case"/":r=t/e;break;default:r=-1}return r},calculate:function(t){for(var e,s,r,n=this.shunt(t),o=[];n.length>0;)if(e=n.shift(),this.isOperator(e)){if(o.length<2)throw new Error("unvalid stack length");r=o.pop(),s=o.pop(),o.push(this.__result(s,r,e))}else{if(e=_.parseInt(e),_.isNaN(e))throw new Error("unvalid expression");o.push(e)}if(1!==o.length)throw new Error("unvalid expression");return o[0]},assoc:function(t){return this.ops[t].assoc},prec:function(t){return this.ops[t].prec},isOperator:function(t){return _.keys(this.ops).indexOf(t)>-1},countMatches:function(t,e){return e="\\"+e,t.length-t.replace(new RegExp(e,"gm"),"").length},fixBracketsPre:function(t){var e=[],s=this.countMatches(t,"(");return s>0&&0===t.indexOf("(")?(e=e.concat(t.substr(0,1)),e=e.concat(this.fixBracketsPre(t.substr(1)))):e=e.concat(t),e},fixBracketsPost:function(t){var e=[],s=this.countMatches(t,"("),r=this.countMatches(t,")");return r>0&&t.lastIndexOf(")")===t.length-1?s>0?(r-s>1&&(e=e.concat(this.fixBracketsPost(t.substr(0,t.length-1))),e=e.concat(t.substr(t.length-1))),r-s===1&&(e=e.concat(t.substr(0,t.length-1)),e=e.concat(t.substr(t.length-1))),1>r-s&&(e=e.concat(t))):(e=e.concat(this.fixBracketsPost(t.substr(0,t.length-1))),e=e.concat(t.substr(t.length-1))):e=e.concat(t),e},fixBrackets:function(t){var e,s=this.fixBracketsPre(t),r=s.pop();for(s=s.concat(this.fixBracketsPost(r)),e=0;e<s.length&&("("===_.first(s)&&")"===_.last(s));e++)s.shift(),s.pop();return s},fixFormulas:function(t){var e,s,r,n=_.indexOf(t,"("),o=_.lastIndexOf(t,")"),i=t;return-1!==n&&-1!==o&&!function(a){return _.forIn(a.formulas,function(c,u){if(c=c.replace(/\s+/g,""),0===t.indexOf(u)&&t.substr(0,n)===u){for(e=t.substring(n+1,o),e=e.split(","),e=a.fixFormulasLoop(_.clone(e),!0),r=0;r<e.length;r++)s=new RegExp("\\$"+(r+1),"g"),c=c.replace(s,"("+e[r]+")");c=a.convert(c),c.unshift("("),c.push(")"),i=c}})}(this),i},fixFormulasLoop:function(t,e){var s,r,n=0,o=0,i=0,a="",c=[],u=[],h=0;for(_.isUndefined(e)&&(e=!1),s=0;s<t.length;s++)1===i?(e?(-1!==t[s].indexOf("(")&&(n+=this.countMatches(t[s],"(")),-1!==t[s].indexOf(")")&&(o+=this.countMatches(t[s],")")),a+=","+t[s]):("("===t[s]&&n++,")"===t[s]&&o++,a+=t[s]),u.push(s),n===o&&(c.push({start:h,formula:a}),a="",i=0,n=0,o=0)):(r=new RegExp(/^\w+\(/),r.test(t[s])&&")"!==_.last(t[s])&&this.countMatches(t[s],"(")!==this.countMatches(t[s],")")&&(i=1,n=this.countMatches(t[s],"("),a+=t[s],h=s));for(s=0;s<c.length;s++)t[c[s].start]=c[s].formula;return _.pullAt(t,u),t},convert:function(t){t=t.replace(/\s+/g,"");var e,s=t.split(/[\+\-\*\/]+/),r=[],n=[],o=0;for(e=0;e<s.length;e++)n=n.concat(this.fixBrackets(s[e])),o+=0===o?s[e].length:s[e].length+1,_.isUndefined(t[o])||n.push(t[o]);for(n=this.fixFormulasLoop(_.clone(n)),e=0;e<n.length;e++)r=r.concat(this.fixFormulas(n[e]));return r},shunt:function(t){function e(t){this.dataStore[this.top++]=t}function s(){return this.dataStore[--this.top]}function r(){return this.dataStore[this.top-1]}function n(){return this.top}function o(){this.dataStore=[],this.top=0,this.push=e,this.pop=s,this.peek=r,this.length=n}var i,a,c,u,h=this.convert(t),l=new o,f=[];for(u=0;u<h.length;u++)if(i=h[u],this.isOperator(i)){for(a=i,c=l.peek();this.isOperator(c)&&("Left"===this.assoc(a)&&this.prec(a)<=this.prec(c)||"Right"===this.assoc(a)&&this.prec(a)<this.prec(c));)f.push(c),l.pop(),c=l.peek();l.push(a)}else if("("===i)l.push(i);else if(")"===i){for(;"("!==l.peek();)f.push(l.pop());l.pop()}else f.push(i);for(;l.length()>0;)f.push(l.pop());return f},addFormulas:function(t){this.formulas=_.assign(this.formulas,t)},removeFormulas:function(){this.formulas=_.clone(Formulas)},calculateCode:function(t){var e=this.parse(t);return function(t){return _.map(e,function(e){return t.calculate(e)})}(this)},parse:function(t){var e,s,r,n=[],o=[];for(t=t.replace(/\s+/g,""),t=t.split(";"),t=_.compact(t),s=0;s<t.length;s++)-1===t[s].indexOf("=")&&n.push({print:"",expressions:[]});for(e=0,s=0;s<t.length;s++)-1===t[s].indexOf("=")?(n[e].print=t[s],e++):n[e].expressions.push(t[s]);for(function(t){_.map(n,function(s){return s.variables={},_.forEach(s.expressions,function(r){if(t.countMatches(r,"=")>1)throw new Error("error code");r=r.split("="),_.chain(r[1]).parseInt().isNaN().value()?(e={},e[r[0]]=r[1],t.addFormulas(e)):s.variables[r[0]]=r[1]}),s})}(this),s=1;s<n.length;s++)n[s].variables=_.assign(_.clone(n[s-1].variables),n[s].variables);return function(t){_.forEach(n,function(e){r=t.convert(e.print),o.push(_.map(r,function(t){return _.isUndefined(e.variables[t])?t:e.variables[t]}).join(""))})}(this),this.removeFormulas(),o}};"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=Calculator:(window.happycalculator=Calculator,void 0===window&&(self.happycalculator=Calculator),"function"==typeof define&&define.amd&&define("happycalculator",["lodash"],function(){return Calculator}));